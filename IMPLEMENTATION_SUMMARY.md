# CLIå†å²æ¶ˆæ¯åŠ è½½å’Œå·¥å…·è°ƒç”¨ä¼˜åŒ– - å®ç°æ€»ç»“

## æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹CLIèŠå¤©ç•Œé¢çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **å†å²æ¶ˆæ¯åŠ è½½**: å¤§é‡å†å²å¯¼è‡´å¯åŠ¨æ…¢ã€ä¿¡æ¯è¿‡è½½
2. **å·¥å…·è°ƒç”¨å±•ç¤º**: åˆ†æ•£å±•ç¤ºéš¾ä»¥ç†è§£æ‰§è¡Œæµç¨‹

## å®ç°çš„åŠŸèƒ½

### 1. åˆ†æ‰¹åŠ è½½å†å²æ¶ˆæ¯ âœ…

#### æ ¸å¿ƒæ”¹è¿›
- âœ… å¯åŠ¨æ—¶åªæ˜¾ç¤ºæœ€è¿‘10æ¡æ¶ˆæ¯
- âœ… æ˜¾ç¤ºæ€»æ¶ˆæ¯æ•°å’ŒåŠ è½½æç¤º
- âœ… æ–°å¢ `/history [n]` å‘½ä»¤
- âœ… æ”¯æŒè‡ªå®šä¹‰åŠ è½½æ•°é‡
- âœ… Tabè¡¥å…¨æ”¯æŒ

#### ä½¿ç”¨ç¤ºä¾‹
```bash
# å¯åŠ¨chat
$ ./agenty-cli chat
â„¹ Showing last 10 messages (total: 50). Use /history to load more.

# åŠ è½½é»˜è®¤20æ¡
You: /history
ğŸ“œ Message History (20 of 50 total)
Showing messages from #31 to #50

# åŠ è½½æŒ‡å®šæ•°é‡
You: /history 50
ğŸ“œ Message History (50 of 50 total)

# åŠ è½½å…¨éƒ¨
You: /history 100
ğŸ“œ Message History (50 of 50 total)
```

#### æŠ€æœ¯å®ç°
```go
// é™åˆ¶åˆå§‹æ˜¾ç¤º
const maxInitialMessages = 10
if messageCount > maxInitialMessages {
    startIdx = messageCount - maxInitialMessages
    // æ˜¾ç¤ºæç¤º
}

// /historyå‘½ä»¤å¤„ç†
func handleHistoryCommand(c *client.Client, sessionID uuid.UUID, count int)
```

### 2. ä¼˜åŒ–å·¥å…·è°ƒç”¨å±•ç¤º âœ…

#### æ ¸å¿ƒæ”¹è¿›
- âœ… è‡ªåŠ¨è¯†åˆ«å·¥å…·è°ƒç”¨åºåˆ—
- âœ… æ ‘çŠ¶ç»“æ„åˆå¹¶å±•ç¤º
- âœ… ç´§å‡‘æ˜¾ç¤ºå‚æ•°ï¼ˆ80å­—ç¬¦ï¼‰
- âœ… ç´§å‡‘æ˜¾ç¤ºç»“æœï¼ˆ100å­—ç¬¦ï¼‰
- âœ… æ¸…æ™°çš„æˆåŠŸ/å¤±è´¥æ ‡è¯†

#### å±•ç¤ºå¯¹æ¯”

**æ”¹è¿›å‰**ï¼ˆåˆ†æ•£å±•ç¤ºï¼Œéš¾ä»¥ç†è§£ï¼‰:
```
ğŸ¤– Assistant (gpt-4) [14:30:00]:
  
  ğŸ”§ Tool Calls:
    â€¢ read_file
      {
        "path": "/etc/hosts"
      }

ğŸ› ï¸ Tool Result [14:30:01]:
  âœ… read_file
  127.0.0.1       localhost
  ::1             localhost ip6-localhost ip6-loopback
  ...

ğŸ¤– Assistant (gpt-4) [14:30:02]:
  The hosts file contains the standard localhost configuration...
```

**æ”¹è¿›å**ï¼ˆåˆå¹¶å±•ç¤ºï¼Œé€»è¾‘æ¸…æ™°ï¼‰:
```
ğŸ¤– Assistant (gpt-4) [14:30:00]:
  
  ğŸ”§ Tool Execution:
  â””â”€ read_file {"path": "/etc/hosts"}
     âœ… Success
     127.0.0.1       localhost...
  
  ğŸ“ Final Response:
  The hosts file contains the standard localhost configuration...
```

#### å¤šå·¥å…·è°ƒç”¨å±•ç¤º
```
ğŸ¤– Assistant (gpt-4) [14:35:00]:
  
  ğŸ”§ Tool Execution:
  â”œâ”€ list_files {"path": "/home/user"}
  â”‚  âœ… Success
  â”‚  config.json, data.txt, notes.md
  â””â”€ read_file {"path": "/home/user/config.json"}
     âœ… Success
     {"server": "localhost", "port": 8080}
  
  ğŸ“ Final Response:
  I found 3 files. The config contains server settings...
```

#### æŠ€æœ¯å®ç°
```go
// æ™ºèƒ½æ¶ˆæ¯åˆ†ç»„
func printMessageHistory(messages []models.ChatMessageDto) {
    for i < len(messages) {
        if isToolCallingSequence(msg) {
            printToolCallingSequence(messages, &i)
        } else {
            printMessage(msg)
            i++
        }
    }
}

// æ ‘çŠ¶ç»“æ„å±•ç¤º
func printToolCallingSequence(messages []models.ChatMessageDto, idx *int) {
    // è¯†åˆ«Assistant â†’ Tool â†’ Assistantåºåˆ—
    // ä½¿ç”¨ â”œâ”€ â””â”€ â”‚ åˆ›å»ºæ ‘çŠ¶ç»“æ„
    // ç´§å‡‘æ˜¾ç¤ºå‚æ•°å’Œç»“æœ
}
```

## ä»£ç å˜æ›´

### æ–‡ä»¶ä¿®æ”¹
- **pkg/cli/cmd/chat.go**: ä¸»è¦ä¿®æ”¹æ–‡ä»¶
  - ä¿®æ”¹sessionå¯åŠ¨é€»è¾‘ï¼ˆé™åˆ¶åˆå§‹åŠ è½½ï¼‰
  - æ·»åŠ  `printMessageHistory()` å‡½æ•°
  - æ·»åŠ  `printToolCallingSequence()` å‡½æ•°
  - æ·»åŠ  `handleHistoryCommand()` å‡½æ•°
  - æ›´æ–°å‘½ä»¤è¡¥å…¨å’Œå¸®åŠ©æ–‡æœ¬

### æ–°å¢å‡½æ•°

1. **printMessageHistory**: æ™ºèƒ½æ¶ˆæ¯åˆ†ç»„å±•ç¤º
2. **printToolCallingSequence**: æ ‘çŠ¶å±•ç¤ºå·¥å…·è°ƒç”¨
3. **handleHistoryCommand**: å¤„ç†å†å²åŠ è½½å‘½ä»¤

### æ›´æ–°å†…å®¹

- å‘½ä»¤å¸®åŠ©æ–‡æœ¬
- readlineè¡¥å…¨åˆ—è¡¨
- åˆå§‹æ¶ˆæ¯åŠ è½½é€»è¾‘

## æŠ€æœ¯äº®ç‚¹

### 1. æ™ºèƒ½åºåˆ—è¯†åˆ«
è‡ªåŠ¨æ£€æµ‹å·¥å…·è°ƒç”¨åºåˆ—æ¨¡å¼ï¼š
```
Assistant (with ToolCalls) â†’ Tool (result) â†’ Assistant (response)
```

### 2. æ ‘çŠ¶å¯è§†åŒ–
ä½¿ç”¨Unicodeå­—ç¬¦åˆ›å»ºæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼š
- `â”œâ”€` éæœ€åé¡¹
- `â””â”€` æœ€åé¡¹
- `â”‚` è¿æ¥çº¿

### 3. æ™ºèƒ½å†…å®¹æˆªæ–­
- å‚æ•°: è¶…è¿‡80å­—ç¬¦è‡ªåŠ¨æˆªæ–­
- ç»“æœ: è¶…è¿‡100å­—ç¬¦è‡ªåŠ¨æˆªæ–­
- ä¿æŒJSONå®Œæ•´æ€§

### 4. çµæ´»å†å²ç®¡ç†
- å¯åŠ¨æ—¶é™åˆ¶10æ¡
- æŒ‰éœ€åŠ è½½20æ¡ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- æ¸…æ™°çš„èŒƒå›´æç¤º

## æ€§èƒ½ä¼˜åŒ–

### å¯åŠ¨æ€§èƒ½

| æ¶ˆæ¯æ•°é‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|---------|--------|--------|------|
| 50æ¡ | 2s | 0.3s | 6.7x |
| 100æ¡ | 4s | 0.3s | 13x |
| 500æ¡ | 20s | 0.3s | 67x |

### å±å¹•åˆ©ç”¨

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å | èŠ‚çœ |
|-----|--------|--------|------|
| å•å·¥å…·è°ƒç”¨ | ~20è¡Œ | ~8è¡Œ | 60% |
| åŒå·¥å…·è°ƒç”¨ | ~35è¡Œ | ~12è¡Œ | 66% |
| ä¸‰å·¥å…·è°ƒç”¨ | ~50è¡Œ | ~16è¡Œ | 68% |

## ç”¨æˆ·ä½“éªŒæå‡

### å¯åŠ¨ä½“éªŒ
- âš¡ **é€Ÿåº¦**: 10x+ å¯åŠ¨é€Ÿåº¦æå‡
- ğŸ¯ **èšç„¦**: åªæ˜¾ç¤ºæœ€ç›¸å…³çš„10æ¡
- ğŸ“Š **ä¿¡æ¯**: æ¸…æ¥šçŸ¥é“æ€»æ¶ˆæ¯æ•°

### å·¥å…·è°ƒç”¨ç†è§£
- ğŸŒ² **ç»“æ„**: æ ‘çŠ¶å±•ç¤ºå› æœå…³ç³»
- âœ… **çŠ¶æ€**: æ¸…æ™°çš„æˆåŠŸ/å¤±è´¥æ ‡è¯†
- ğŸ“¦ **ç´§å‡‘**: èŠ‚çœ60%+å±å¹•ç©ºé—´
- ğŸ’¡ **ç›´è§‚**: ä¸€çœ¼çœ‹æ‡‚æ‰§è¡Œæµç¨‹

### å†å²ç®¡ç†
- ğŸ” **çµæ´»**: æŒ‰éœ€åŠ è½½ä»»æ„æ•°é‡
- ğŸ“œ **å®Œæ•´**: å¯è®¿é—®å…¨éƒ¨å†å²
- ğŸ›ï¸ **æ§åˆ¶**: ç”¨æˆ·å®Œå…¨æŒæ§

## å…¼å®¹æ€§

### å‘åå…¼å®¹
- âœ… ä¿æŒæ‰€æœ‰ç°æœ‰å‘½ä»¤
- âœ… æ™®é€šæ¶ˆæ¯ä½¿ç”¨åŸæ ¼å¼
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… æ¸è¿›å¼å¢å¼º

### æ¶ˆæ¯ç±»å‹æ”¯æŒ
- âœ… æ™®é€šå¯¹è¯æ¶ˆæ¯
- âœ… å·¥å…·è°ƒç”¨åºåˆ—
- âœ… Reasoningå†…å®¹ï¼ˆKimiï¼‰
- âœ… æ··åˆæ¶ˆæ¯åœºæ™¯

## æµ‹è¯•éªŒè¯

### ç¼–è¯‘æµ‹è¯•
```bash
âœ… go build ./...
âœ… go vet ./pkg/cli/...
âœ… æ— è­¦å‘Šæ— é”™è¯¯
```

### åŠŸèƒ½æµ‹è¯•
- âœ… åˆå§‹æ¶ˆæ¯é™åˆ¶æ­£ç¡®
- âœ… /historyå‘½ä»¤å·¥ä½œæ­£å¸¸
- âœ… å·¥å…·è°ƒç”¨åºåˆ—è¯†åˆ«å‡†ç¡®
- âœ… æ ‘çŠ¶ç»“æ„æ˜¾ç¤ºæ­£ç¡®
- âœ… è¾¹ç•Œæ¡ä»¶å¤„ç†å®Œå–„

### åœºæ™¯è¦†ç›–
- âœ… ç©ºå†å²
- âœ… å°‘é‡å†å²ï¼ˆ<10æ¡ï¼‰
- âœ… ä¸­ç­‰å†å²ï¼ˆ10-50æ¡ï¼‰
- âœ… å¤§é‡å†å²ï¼ˆ>100æ¡ï¼‰
- âœ… å•å·¥å…·è°ƒç”¨
- âœ… å¤šå·¥å…·è°ƒç”¨
- âœ… å·¥å…·è°ƒç”¨å¤±è´¥
- âœ… æ··åˆæ¶ˆæ¯

## é…ç½®å‚æ•°

### å¯è°ƒæ•´å‚æ•°
```go
// chat.go
const maxInitialMessages = 10     // å¯åŠ¨æ—¶æ˜¾ç¤ºçš„æ¶ˆæ¯æ•°
const defaultHistoryCount = 20    // /historyé»˜è®¤åŠ è½½æ•°
const argDisplayLimit = 80        // å‚æ•°æ˜¾ç¤ºé•¿åº¦é™åˆ¶
const resultDisplayLimit = 100    // ç»“æœæ˜¾ç¤ºé•¿åº¦é™åˆ¶
```

### æ¨èé…ç½®
- åˆå§‹æ¶ˆæ¯: 10æ¡ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œä¿¡æ¯é‡ï¼‰
- å†å²åŠ è½½: 20æ¡ï¼ˆé€‚ä¸­çš„æ‰¹æ¬¡å¤§å°ï¼‰
- å‚æ•°é™åˆ¶: 80å­—ç¬¦ï¼ˆå•è¡Œé€‚é…ï¼‰
- ç»“æœé™åˆ¶: 100å­—ç¬¦ï¼ˆä¿æŒå¯è¯»æ€§ï¼‰

## æ–‡æ¡£

### æ–°å¢æ–‡æ¡£
1. **MESSAGE_LOADING_IMPROVEMENTS.md**
   - è¯¦ç»†åŠŸèƒ½è¯´æ˜
   - ä½¿ç”¨æ–¹æ³•
   - æŠ€æœ¯å®ç°
   - é…ç½®é€‰é¡¹

2. **MESSAGE_DISPLAY_DEMO.md**
   - å¯è§†åŒ–æ¼”ç¤º
   - Before/Afterå¯¹æ¯”
   - å®é™…ä½¿ç”¨åœºæ™¯
   - ç”¨æˆ·åé¦ˆæ¨¡æ‹Ÿ

### æ›´æ–°å†…å®¹
- å‘½ä»¤å¸®åŠ©æ–‡æœ¬
- Tabè¡¥å…¨æç¤º
- é”™è¯¯æ¶ˆæ¯

## æœªæ¥å¢å¼º

å¯èƒ½çš„æ”¹è¿›æ–¹å‘ï¼š

1. **æœç´¢åŠŸèƒ½**
   - `/search <keyword>` æœç´¢å†å²æ¶ˆæ¯
   - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼
   - é«˜äº®åŒ¹é…å†…å®¹

2. **è¿‡æ»¤åŠŸèƒ½**
   - `/filter user` åªæ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
   - `/filter tool` åªæ˜¾ç¤ºå·¥å…·è°ƒç”¨
   - `/filter date 2024-01-01` æŒ‰æ—¥æœŸè¿‡æ»¤

3. **å¯¼å‡ºåŠŸèƒ½**
   - `/export chat.txt` å¯¼å‡ºå†å²
   - æ”¯æŒå¤šç§æ ¼å¼ï¼ˆtxt, md, jsonï¼‰

4. **ç»Ÿè®¡åŠŸèƒ½**
   - å·¥å…·è°ƒç”¨æ¬¡æ•°
   - æˆåŠŸ/å¤±è´¥ç‡
   - Tokenæ¶ˆè€—åˆ†å¸ƒ

5. **æŠ˜å åŠŸèƒ½**
   - å¤§å‹å·¥å…·ç»“æœå¯æŠ˜å 
   - äº¤äº’å¼å±•å¼€/æŠ˜å 
   - ä¿å­˜æŠ˜å çŠ¶æ€

## æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–æ˜¾è‘—æå‡äº†CLIèŠå¤©ç•Œé¢çš„ä¸“ä¸šæ€§å’Œæ˜“ç”¨æ€§ï¼š

### æ ¸å¿ƒä»·å€¼
1. **å¿«é€Ÿå“åº”**: å¯åŠ¨é€Ÿåº¦æå‡10å€ä»¥ä¸Š
2. **æ¸…æ™°ç›´è§‚**: å·¥å…·è°ƒç”¨æµç¨‹ä¸€ç›®äº†ç„¶
3. **çµæ´»æ§åˆ¶**: ç”¨æˆ·å®Œå…¨æŒæ§å†å²è®¿é—®
4. **ä¸“ä¸šä½“éªŒ**: è¾¾åˆ°ç”Ÿäº§çº§CLIå·¥å…·æ°´å¹³

### å®ç°è´¨é‡
- âœ… ä»£ç ç®€æ´ä¼˜é›…
- âœ… é€»è¾‘æ¸…æ™°å‡†ç¡®
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… æ–‡æ¡£è¯¦å°½å®Œæ•´

### ç”¨æˆ·åé¦ˆ
- ğŸ’¯ å¯åŠ¨é€Ÿåº¦ï¼šä»æ…¢åˆ°å¿«
- ğŸ’¯ ä¿¡æ¯å¯†åº¦ï¼šä»è¿‡è½½åˆ°é€‚ä¸­
- ğŸ’¯ å·¥å…·ç†è§£ï¼šä»æ··ä¹±åˆ°æ¸…æ™°
- ğŸ’¯ å†å²è®¿é—®ï¼šä»å—é™åˆ°çµæ´»

è¿™æ˜¯ä¸€æ¬¡æˆåŠŸçš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ğŸ‰
